function HomeCtrl($scope,$rootScope,AngularForce,$location,$route,$filter){function addHammer(){0==$scope.drilledDown&&"all"!=$scope.activeDF&&$("rect.c3-event-rect").off().hammer().on("doubletap",function(){if("all"==$scope.activeDF)var _filter=$scope.graphDataAll[$(this).index()+1];else if("pipeline"==$scope.activeDF)var _filter=$scope.graphDataPipeline[$(this).index()+1];else if("closed"==$scope.activeDF)var _filter=$scope.graphDataClosed[$(this).index()+1];$scope.drillDownGraph(_filter)})}$scope.data={},$scope.init={};var headings={allfranco:"All Opportunities per Franco ('000)",allsector:"All Opportunities per Sector ('000)",pipelinefranco:"All Pipeline Opportunities per Franco ('000)",pipelinesector:"All Pipeline Opportunities per Sector ('000)",closedfranco:"All Closed Opportunities per Franco ('000)",closedsector:"All Closed Opportunities per Sector ('000)"},legends={};if(legends.all={Pipeline:"pipeLineRev","Closed - Won":"ClosedWonRev","Closed - Lost":"ClosedLostRev"},legends.pipeline={"C Cov":"cCovRev",GM:"gmRev",IB:"ibRev",TPS:"tpsRev",RE:"reRev",BE:"beRev",GMGT:"glmRev"},legends.closed={"Closed - Won - PY":"WonPY","Closed - Won - CY":"WonCY","Closed - Lost - PY":"LostPY","Closed - Lost - CY":"LostCY"},$scope.activeDFIcon="map",$scope.filtered=!1,$scope.drilledDown=!1,$scope.activeView="chart",$scope.authenticated=AngularForce.authenticated(),AngularForce.inVisualforce=!0,!$scope.authenticated){if(!AngularForce.inVisualforce)return $location.path("/login");AngularForce.login()}$scope.logout=function(){AngularForce.logout(),$location.path("/login")},$scope.init.all=function(grouped,type,filter){"sector"==$scope.activeDSF&&(type="sector");var allOpportunitiesCYRev=0,allOpportunitiesTotalRev=0,allOpportunitiesPipeline=["Pipeline"],allOpportunitiesClosedWon=["Closed - Won"],allOpportunitiesClosedLost=["Closed - Lost"],oppList=["x"],oppCount=0;if("sector"==type)var allOpportunities=$rootScope.allOpportunitiesSector;else var allOpportunities=$rootScope.allOpportunitiesFranco;$scope.allOpportunities=allOpportunities,"all"==$scope.activeDF&&($scope.activeTabFranco=allOpportunities);for(var i=0;i<allOpportunities.length;i++)(filter&&allOpportunities[i].oppFranco==filter||filter&&allOpportunities[i].oppSector==filter||!filter)&&(allOpportunitiesCYRev+=allOpportunities[i].ClosedWonRev+allOpportunities[i].ClosedLostRev,allOpportunitiesTotalRev+=allOpportunities[i].totalRev,oppList.push("sector"==type?allOpportunities[i].oppSector:allOpportunities[i].oppFranco),oppCount+=allOpportunities[i].oppCount,allOpportunitiesPipeline.push(allOpportunities[i].pipeLineRev),allOpportunitiesClosedWon.push(allOpportunities[i].ClosedWonRev),allOpportunitiesClosedLost.push(allOpportunities[i].ClosedLostRev));$scope.graphDataAll=oppList,$scope.allOpportunitiesCYRev=$filter("number")(allOpportunitiesCYRev,0),$scope.allOpportunitiesTotalRev=$filter("number")(allOpportunitiesTotalRev,0),$scope.oppNumber=oppCount,$scope.data.all=0==grouped?{columns:[oppList,allOpportunitiesPipeline,allOpportunitiesClosedWon,allOpportunitiesClosedLost],groups:[["Pipeline"],["Closed - Won"],["Closed - Lost"]]}:{columns:[oppList,allOpportunitiesPipeline,allOpportunitiesClosedWon,allOpportunitiesClosedLost],groups:["Pipeline","Closed - Won","Closed - Lost"]}},$scope.init.pipeline=function(grouped,type,filter){"sector"==$scope.activeDSF&&(type="sector");var allOpportunityPipelineDivlstCYRev=0,allOpportunityPipelineDivlstCYTotalRev=0,pipeOpCount=0,pipelineList=["x"],ccon=["C Cov"],gm=["GM"],ib=["IB"],tps=["TPS"],re=["RE"],be=["BE"],glm=["GMGT"];if("sector"==type){var allOpportunityPipelineDivlst=$rootScope.allOpportunityPipelineSectorDivlst,topOpp=$rootScope.sectorTopOpp;$scope.selectedItem="Sector"}else{var allOpportunityPipelineDivlst=$rootScope.allOpportunityPipelineDivlst,topOpp=$rootScope.topOpp;$scope.selectedItem="Franco"}$scope.allOpportunityPipelineDivlst=allOpportunityPipelineDivlst,"pipeline"==$scope.activeDF&&($scope.activeTabFranco=allOpportunityPipelineDivlst),$scope.topOpp=topOpp;for(var i=0;i<allOpportunityPipelineDivlst.length;i++)(filter&&allOpportunityPipelineDivlst[i].oppFranco==filter||filter&&allOpportunityPipelineDivlst[i].oppSector==filter||!filter)&&(allOpportunityPipelineDivlstCYRev+=allOpportunityPipelineDivlst[i].currYearRev,allOpportunityPipelineDivlstCYTotalRev+=allOpportunityPipelineDivlst[i].totalRev,pipeOpCount+=allOpportunityPipelineDivlst[i].oppPipelineCount,pipelineList.push("sector"==type?allOpportunityPipelineDivlst[i].oppSector:allOpportunityPipelineDivlst[i].oppFranco),ccon.push(allOpportunityPipelineDivlst[i].cCovRev),gm.push(allOpportunityPipelineDivlst[i].gmRev),ib.push(allOpportunityPipelineDivlst[i].ibRev),tps.push(allOpportunityPipelineDivlst[i].tpsRev),re.push(allOpportunityPipelineDivlst[i].reRev),be.push(allOpportunityPipelineDivlst[i].beRev),glm.push(allOpportunityPipelineDivlst[i].glmRev));$scope.graphDataPipeline=pipelineList,$scope.allOpportunityPipelineDivlstCYRev=$filter("number")(allOpportunityPipelineDivlstCYRev,0),$scope.allOpportunityPipelineDivlstCYTotalRev=$filter("number")(allOpportunityPipelineDivlstCYTotalRev,0),$scope.pipeOpCount=pipeOpCount,$scope.data.pipeline=0==grouped?{columns:[pipelineList,ccon,gm,ib,tps,re,be,glm],groups:[["C Cov"],["GM"],["IB"],["TPS"],["RE"],["BE"],["GMGT"]]}:{columns:[pipelineList,ccon,gm,ib,tps,re,be,glm],groups:["C Cov","GM","IB","TPS","RE","BE","GMGT"]}},$scope.init.closed=function(grouped,type){"sector"==$scope.activeDSF&&(type="sector");var allClosedOpportunitylstCYWonRev=0,allClosedOpportunitylstCYLostRev=0,closedOpCount=0,oppListClosed=["x"],ClosedWonPY=["Closed - Won - PY"],ClosedWonCY=["Closed - Won - CY"],ClosedLostPY=["Closed - Lost - PY"],ClosedLostCY=["Closed - Lost - CY"];if("sector"==type)var allClosedOpportunitylst=$rootScope.allClosedOpportunitySeclst;else var allClosedOpportunitylst=$rootScope.allClosedOpportunitylst;$scope.allClosedOpportunitylst=allClosedOpportunitylst,"closed"==$scope.activeDF&&($scope.activeTabFranco=allClosedOpportunitylst);for(var i=0;i<allClosedOpportunitylst.length;i++)allClosedOpportunitylstCYWonRev+=allClosedOpportunitylst[i].ClosedWonCYRev,allClosedOpportunitylstCYLostRev+=allClosedOpportunitylst[i].ClosedLostCYRev,oppListClosed.push("sector"==type?allClosedOpportunitylst[i].oppSector:allClosedOpportunitylst[i].oppFranco),ClosedWonPY.push(allClosedOpportunitylst[i].ClosedWonPYRev),ClosedWonCY.push(allClosedOpportunitylst[i].ClosedWonCYRev),ClosedLostPY.push(allClosedOpportunitylst[i].ClosedLostPYRev),ClosedLostCY.push(allClosedOpportunitylst[i].ClosedLostCYRev);closedOpCount=allClosedOpportunitylstCYWonRev/(allClosedOpportunitylstCYWonRev+allClosedOpportunitylstCYLostRev)*100,$scope.graphDataClosed=oppListClosed,$scope.allClosedOpportunitylstCYWonRev=$filter("number")(allClosedOpportunitylstCYWonRev,0),$scope.allClosedOpportunitylstCYLostRev=$filter("number")(allClosedOpportunitylstCYLostRev,0),$scope.closedOpCount=isNaN(closedOpCount)?"N/A":$filter("number")(closedOpCount,0)+"%",$scope.data.closed=0==grouped?{columns:[oppListClosed,ClosedWonPY,ClosedWonCY,ClosedLostPY,ClosedLostCY],groups:[["Closed - Won - PY"],["Closed - Won - CY"],["Closed - Lost - PY"],["Closed - Lost - CY"]]}:{columns:[oppListClosed,ClosedWonPY,ClosedWonCY,ClosedLostPY,ClosedLostCY],groups:["Closed - Won - PY","Closed - Won - CY","Closed - Lost - PY","Closed - Lost - CY"]}},$scope.drillDownGraph=function(element){var dataSource={},drillDown={},dataLegends=[],dataLegendsGrouped=[],francolist=["x"],sectorlist=["x"],allOpportunityPipelineDivlstCYRev=0,allOpportunityPipelineDivlstCYTotalRev=0,pipeOpCount=0,closedOpCount=0;if("All"!=element){if("pipeline"==$scope.activeDF?dataSource=$scope.allOpportunityPipelineFrancolst:"closed"==$scope.activeDF&&(dataSource=$scope.allOpportunityClosedFrancolst),Array.prototype.inArray=function(comparer){for(var i=0;i<this.length;i++)if(comparer(this[i]))return!0;return!1},Array.prototype.pushIfNotExist=function(element,comparer){this.inArray(comparer)||this.push(element)},"franco"==$scope.activeDSF){drillDown=$filter("filter")(dataSource,{oppFranco:element},!0);for(var i=0;i<drillDown.length;i++)sectorlist.pushIfNotExist(drillDown[i].oppSector,function(e){return e===drillDown[i].oppSector});var targetList=sectorlist}else{drillDown=$filter("filter")(dataSource,{oppSector:element},!0);for(var i=0;i<drillDown.length;i++)francolist.pushIfNotExist(drillDown[i].oppFranco,function(e){return e===drillDown[i].oppFranco});var targetList=francolist}console.log(sectorlist),$.each(Object.keys(legends[$scope.activeDF]),function(k,v){dataLegends.push([v]),dataLegendsGrouped.push(v)});var columnData=$.extend(!0,[],dataLegends);if(console.log(columnData),drillDown.length>0){if($scope.selectedItem=element,$("#chart-container nav button.active").removeClass("active"),$("#chart-container nav button").each(function(){$(this).text().trim()==element&&$(this).addClass("active")}),$scope.drilledDown=!0,"pipeline"==$scope.activeDF){$scope.topOpp="franco"==$scope.activeDSF?$filter("filter")($scope.topOppPipelineDrillDownFranco,{oppFranco:element},!0):$filter("filter")($scope.topOppPipelineDrillDownSector,{oppSector:element},!0);for(var i=0;i<drillDown.length;i++)allOpportunityPipelineDivlstCYRev+=drillDown[i].currYearRev,allOpportunityPipelineDivlstCYTotalRev+=drillDown[i].totalRev,pipeOpCount+=drillDown[i].oppPipelineCount;$scope.allOpportunityPipelineDivlstCYRev=$filter("number")(allOpportunityPipelineDivlstCYRev,0),$scope.allOpportunityPipelineDivlstCYTotalRev=$filter("number")(allOpportunityPipelineDivlstCYTotalRev,0),$scope.pipeOpCount=pipeOpCount}else if("closed"==$scope.activeDF){$scope.allClosedOpportunitylstCYWonRev=0,$scope.allClosedOpportunitylstCYLostRev=0,$scope.closedOpCount=0;for(var i=0;i<drillDown.length;i++)$scope.allClosedOpportunitylstCYWonRev+=drillDown[i].WonCY,$scope.allClosedOpportunitylstCYLostRev+=drillDown[i].LostCY;closedOpCount=$scope.allClosedOpportunitylstCYWonRev/($scope.allClosedOpportunitylstCYWonRev+$scope.allClosedOpportunitylstCYLostRev)*100,$scope.allClosedOpportunitylstCYWonRev=$filter("number")($scope.allClosedOpportunitylstCYWonRev,0),$scope.allClosedOpportunitylstCYLostRev=$filter("number")($scope.allClosedOpportunitylstCYLostRev,0),$scope.closedOpCount=isNaN(closedOpCount)?"N/A":$filter("number")(closedOpCount,0)+"%",$scope.top5WonClosedOpportunitylst="franco"==$scope.activeDSF?null!=$filter("filter")($scope.topOppClosedWonDrillDownFranco,{oppFranco:element},!0)?$filter("filter")($scope.topOppClosedWonDrillDownFranco,{oppFranco:element},!0):"":null!=$filter("filter")($scope.topOppClosedWonPipelineDrillDownSector,{oppSector:element},!0)?$filter("filter")($scope.topOppClosedWonPipelineDrillDownSector,{oppSector:element},!0):"",$scope.top5LostClosedOpportunitylst="franco"==$scope.activeDSF?null!=$filter("filter")($scope.topOppClosedLostDrillDownFranco,{oppFranco:element},!0)?$filter("filter")($scope.topOppClosedLostDrillDownFranco,{oppFranco:element},!0):"":null!=$filter("filter")($scope.topOppClosedLostPipelineDrillDownSector,{oppSector:element},!0)?$filter("filter")($scope.topOppClosedLostPipelineDrillDownSector,{oppSector:element},!0):""}for(var hasChartData=!1,i=0;i<dataLegends.length;i++){var source=null;$.each(targetList,function(k,v){if("x"!=v){source="franco"==$scope.activeDSF?$filter("filter")(drillDown,{oppSector:v},!0):$filter("filter")(drillDown,{oppFranco:v},!0);for(var aggregatedDataValues=0,m=0;m<source.length;m++)aggregatedDataValues+=source[m][legends[$scope.activeDF][dataLegends[i][0]]];aggregatedDataValues>0&&(hasChartData=!0,console.log("more than 0")),columnData[i].push(aggregatedDataValues)}})}if("undefined"!=typeof columnData){columnData.unshift(targetList);var data={columns:columnData,groups:dataLegendsGrouped};console.log(hasChartData),1==hasChartData?($scope.initGraph(data),$scope.initLegend(data)):$("#chart").html('<p class="notice">There is currently no detailed graph data available for '+element+"</p>"),$scope.heading=headings[$scope.activeDF+$scope.activeDSF]+" - "+element,$scope.$apply()}}else $("#main-modal .modal-title").html("No data"),$("#main-modal .modal-body").html("No Data available for "+element),$("#main-modal").modal({show:!0,backdrop:"static"})}else $("#chart-container nav button.active").removeClass("active"),$("#chart-container nav button:first-child").addClass("active"),$scope.init[$scope.activeDF](!0,$scope.activeDSF),$scope.initGraph($scope.data[$scope.activeDF]),$scope.initLegend($scope.data[$scope.activeDF]),$scope.drilledDown=!1,$scope.filtered=!1,$scope.heading=headings[$scope.activeDF+$scope.activeDSF]};var chart=null;$scope.initGraph=function(data){chart=c3.generate({bindto:"#chart",color:{pattern:["#1996D0","#6BD0FF","#1FB8FF","#3E6B7F","#1993CC","#9324A6","#C46DD2","#B22CC9","#45264A","#852196"]},data:{x:"x",columns:data.columns,groups:[data.groups],type:"bar"},axis:{x:{type:"category",tick:{rotate:70},height:130},y:{tick:{format:function(d){return"R"+(d/1e3).formatMoney(2,",")}}}},grid:{y:{show:!0}},legend:{show:!1}}),setTimeout(function(){addHammer()},1050)},$scope.updateGraph=function(data,unload){1==unload&&chart.unload(),chart.load({columns:data.columns}),chart.groups([data.groups]),setTimeout(function(){addHammer()},1050)},$scope.initLegend=function(data){if($("#chart .legend").length){$("#chart .legend").html("");var legend=d3.select("#chart .legend")}else var legend=d3.select("#chart").append("div",".chart").attr("class","legend");$.each(data.groups,function(index,val){legend.append("div").attr("data-id",val).html("<span></span>"+val)}),d3.selectAll(".legend div").each(function(){var id=d3.select(this).attr("data-id");d3.select(this).selectAll("span").style("background-color",chart.color(id))}).on("click",function(){var id=d3.select(this).attr("data-id"),_this=$(this);chart.toggle(id),_this.hasClass("inactive")?_this.removeClass("inactive"):_this.addClass("inactive"),addHammer()}),/iPhone|iPad|iPod/i.test(navigator.userAgent)||/Android/i.test(navigator.userAgent)||d3.selectAll(".legend div").on("mouseover",function(){var id=d3.select(this).attr("data-id");chart.focus(id)}).on("mouseout",function(){d3.select(this).attr("data-id");chart.revert()})},$scope.toggleChart=function(){var _this=$("#toggle-chart"),_chart=$("#chart-container"),_img=_this.find("img");_chart.is(":visible")?($("#chart-container").slideUp(),_img.attr("src",_img.attr("src").replace("minus.png","plus.png"))):($("#chart-container").slideDown(),_img.attr("src",_img.attr("src").replace("plus.png","minus.png")))},$scope.handleToggle=function(element){$scope.drilledDown=!1,$("#top-tabs .col").removeClass("active"),$(element.currentTarget).addClass("active");var activeTab=$(element.currentTarget).attr("id");switch($(".gridData").addClass("hidden"),$("#"+activeTab+"Tab").removeClass("hidden"),activeTab){case"all":$scope.activeDSF="franco",$scope.activeDFIcon="map",$("#toggleFrancoSector").parent().find(".h4.active").removeClass("active").parent().find(".h4:last-child").addClass("active")}$scope.activeDF=activeTab,$scope.activeDataFeed=$scope.data[activeTab],$.each($scope.init,function(key,val){val()}),$scope.initGraph($scope.data[activeTab]),$scope.initLegend($scope.data[activeTab]),$scope.filtered=!1,$scope.heading=headings[activeTab+$scope.activeDSF],$("#chart-container nav button.active").removeClass("active"),$("#chart-container nav button:first-child").addClass("active")},$scope.toggleFrancoSector=function(element){var destinationSegment="";$(element.currentTarget).parent().find(".h4").each(function(){var _this=$(this);_this.hasClass("active")||(destinationSegment=_this.text()),_this.toggleClass("active")}),"Franco"==destinationSegment?($scope.activeDSF="franco",$scope.activeDFIcon="map"):($scope.activeDSF="sector",$scope.activeDFIcon="cog"),$.each($scope.init,function(key,val){val()}),1==$scope.drilledDown?($scope.initGraph($scope.data[$scope.activeDF]),$scope.initLegend($scope.data[$scope.activeDF]),$scope.drilledDown=!1):$scope.updateGraph($scope.data[$scope.activeDF]),$scope.heading=headings[$scope.activeDF+$scope.activeDSF],$("#chart-container nav button:first-child").addClass("active")},$scope.openInternalLink=function(object){"undefined"!=typeof sforce&&null!=sforce?sforce.one.navigateToSObject(object):window.location.href="/"+object},$scope.activeDF="all",$scope.activeDSF="franco",$scope.heading=headings[$scope.activeDF+$scope.activeDSF],$.each($scope.init,function(key,val){val()}),$scope.activeTabFranco=$rootScope.allOpportunitiesFranco,$scope.$on("$viewContentLoaded",function(){setTimeout(function(){$scope.initGraph($scope.data.all),$scope.initLegend($scope.data.all)},1e3)}),$scope.hideToolTip=function(){$(".c3-tooltip").hide()}}function LoginCtrl($scope,AngularForce,$location){$scope.login=function(){AngularForce.login()},AngularForce.inVisualforce&&(AngularForce.login(),console.log("LoginCtrl just authenticated go to /"),$location.path("/"))}