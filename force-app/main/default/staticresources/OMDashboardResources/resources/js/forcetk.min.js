var forcetk=window.forcetk;void 0===forcetk&&(forcetk={}),void 0===forcetk.Client&&(void 0===window.$j&&($j=$),forcetk.Client=function(clientId,loginUrl,proxyUrl){this.clientId=clientId,this.loginUrl=loginUrl||"https://login.salesforce.com/","undefined"==typeof proxyUrl||null===proxyUrl?(this.proxyUrl="file:"===location.protocol?null:location.protocol+"//"+location.hostname+"/services/proxy",this.authzHeader="Authorization"):(this.proxyUrl=proxyUrl,this.authzHeader="X-Authorization"),this.refreshToken=null,this.sessionId=null,this.apiVersion=null,this.instanceUrl=null,this.asyncAjax=!0},forcetk.Client.prototype.setRefreshToken=function(refreshToken){this.refreshToken=refreshToken},forcetk.Client.prototype.refreshAccessToken=function(callback,error){var that=this,url=this.loginUrl+"/services/oauth2/token";$j.ajax({type:"POST",url:null!==this.proxyUrl?this.proxyUrl:url,cache:!1,processData:!1,data:"grant_type=refresh_token&client_id="+this.clientId+"&refresh_token="+this.refreshToken,success:callback,error:error,dataType:"json",beforeSend:function(xhr){null!==that.proxyUrl&&xhr.setRequestHeader("SalesforceProxy-Endpoint",url)}})},forcetk.Client.prototype.setSessionToken=function(sessionId,apiVersion,instanceUrl){if(this.sessionId=sessionId,this.apiVersion="undefined"==typeof apiVersion||null===apiVersion?"v27.0":apiVersion,"undefined"==typeof instanceUrl||null==instanceUrl){var elements=location.hostname.split("."),instance=3==elements.length?elements[0]:elements[1];this.instanceUrl="https://"+instance+".salesforce.com"}else this.instanceUrl=instanceUrl},forcetk.Client.prototype.ajax=function(path,callback,error,method,payload,retry){var that=this,url=this.instanceUrl+"/services/data"+path;$j.ajax({type:method||"GET",async:this.asyncAjax,url:null!==this.proxyUrl?this.proxyUrl:url,contentType:"application/json",cache:!1,processData:!1,data:payload,success:callback,error:!this.refreshToken||retry?error:function(jqXHR,textStatus,errorThrown){401===jqXHR.status?that.refreshAccessToken(function(oauthResponse){that.setSessionToken(oauthResponse.access_token,null,oauthResponse.instance_url),that.ajax(path,callback,error,method,payload,!0)},error):error(jqXHR,textStatus,errorThrown)},dataType:"json",beforeSend:function(xhr){null!==that.proxyUrl&&xhr.setRequestHeader("SalesforceProxy-Endpoint",url),xhr.setRequestHeader(that.authzHeader,"OAuth "+that.sessionId),xhr.setRequestHeader("X-User-Agent","salesforce-toolkit-rest-javascript-angularjs-node/"+that.apiVersion)}})},forcetk.Client.prototype.getChatterFile=function(path,mimeType,callback,error,retry){var that=this,url=this.instanceUrl+path,request=new XMLHttpRequest;request.open("GET",null!==this.proxyUrl?this.proxyUrl:url,!0),request.responseType="arraybuffer",request.setRequestHeader(that.authzHeader,"OAuth "+that.sessionId),request.setRequestHeader("X-User-Agent","salesforce-toolkit-rest-javascript-angularjs/"+that.apiVersion),null!==this.proxyUrl&&request.setRequestHeader("SalesforceProxy-Endpoint",url),request.onreadystatechange=function(){if(4==request.readyState)if(200==request.status)try{callback(request.response)}catch(e){alert("Error reading the response: "+e.toString())}else 401!=request.status||retry?error(request,request.statusText,request.response):that.refreshAccessToken(function(oauthResponse){that.setSessionToken(oauthResponse.access_token,null,oauthResponse.instance_url),that.getChatterFile(path,mimeType,callback,error,!0)},error)},request.send()},forcetk.Client.prototype.apexrest=function(path,callback,error,method,payload,retry){var that=this,url=this.instanceUrl+"/services/apexrest"+path;$j.ajax({type:method||"GET",async:this.asyncAjax,url:null!==this.proxyUrl?this.proxyUrl:url,contentType:"application/json",cache:!1,processData:!1,data:payload,success:callback,error:!this.refreshToken||retry?error:function(jqXHR,textStatus,errorThrown){401===jqXHR.status?that.refreshAccessToken(function(oauthResponse){that.setSessionToken(oauthResponse.access_token,null,oauthResponse.instance_url),that.ajax(path,callback,error,method,payload,!0)},error):error(jqXHR,textStatus,errorThrown)},dataType:"json",beforeSend:function(xhr){null!==that.proxyUrl&&xhr.setRequestHeader("SalesforceProxy-Endpoint",url),xhr.setRequestHeader(that.authzHeader,"OAuth "+that.sessionId),xhr.setRequestHeader("X-User-Agent","salesforce-toolkit-rest-javascript/"+that.apiVersion)}})},forcetk.Client.prototype.versions=function(callback,error){this.ajax("/",callback,error)},forcetk.Client.prototype.resources=function(callback,error){this.ajax("/"+this.apiVersion+"/",callback,error)},forcetk.Client.prototype.describeGlobal=function(callback,error){this.ajax("/"+this.apiVersion+"/sobjects/",callback,error)},forcetk.Client.prototype.metadata=function(objtype,callback,error){this.ajax("/"+this.apiVersion+"/sobjects/"+objtype+"/",callback,error)},forcetk.Client.prototype.describe=function(objtype,callback,error){this.ajax("/"+this.apiVersion+"/sobjects/"+objtype+"/describe/",callback,error)},forcetk.Client.prototype.create=function(objtype,fields,callback,error){this.ajax("/"+this.apiVersion+"/sobjects/"+objtype+"/",callback,error,"POST",JSON.stringify(fields))},forcetk.Client.prototype.retrieve=function(objtype,id,fieldlist,callback,error){4==arguments.length&&(error=callback,callback=fieldlist,fieldlist=null);var fields=fieldlist?"?fields="+fieldlist:"";this.ajax("/"+this.apiVersion+"/sobjects/"+objtype+"/"+id+fields,callback,error)},forcetk.Client.prototype.upsert=function(objtype,externalIdField,externalId,fields,callback,error){this.ajax("/"+this.apiVersion+"/sobjects/"+objtype+"/"+externalIdField+"/"+externalId+"?_HttpMethod=PATCH",callback,error,"POST",JSON.stringify(fields))},forcetk.Client.prototype.update=function(objtype,id,fields,callback,error){this.ajax("/"+this.apiVersion+"/sobjects/"+objtype+"/"+id+"?_HttpMethod=PATCH",callback,error,"POST",JSON.stringify(fields))},forcetk.Client.prototype.del=function(objtype,id,callback,error){this.ajax("/"+this.apiVersion+"/sobjects/"+objtype+"/"+id,callback,error,"DELETE")},forcetk.Client.prototype.query=function(soql,callback,error){this.ajax("/"+this.apiVersion+"/query?q="+escape(soql),callback,error)},forcetk.Client.prototype.search=function(sosl,callback,error){this.ajax("/"+this.apiVersion+"/search?q="+escape(sosl),callback,error)});