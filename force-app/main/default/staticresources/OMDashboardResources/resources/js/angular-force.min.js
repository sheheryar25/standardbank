angular.module("AngularForce",[]).service("AngularForce",function(SFConfig){function getForceTKClientUI(){return new forcetk.ClientUI(SFConfig.sfLoginURL,SFConfig.consumerKey,SFConfig.oAuthCallbackURL,function(forcetkClient){console.log("OAuth callback success!"),SFConfig.client=forcetkClient,SFConfig.client.serviceURL=forcetkClient.instanceUrl+"/services/data/"+forcetkClient.apiVersion},function(){},SFConfig.proxyUrl)}this.inVisualforce=document.location.href.indexOf("visual.force.com")>0,this.authenticated=function(){return SFConfig.client?!0:!1},this.login=function(callback){return SFConfig.client?callback&&callback():"file:"===location.protocol&&cordova?this.setCordovaLoginCred(callback):SFConfig.sessionId?this.loginVF():this.loginWeb(callback)},this.setCordovaLoginCred=function(callback){function salesforceSessionRefreshed(creds){var credsData=creds;creds.data&&(credsData=creds.data),SFConfig.client=new forcetk.Client(credsData.clientId,credsData.loginUrl),SFConfig.client.setSessionToken(credsData.accessToken,apiVersion,credsData.instanceUrl),SFConfig.client.setRefreshToken(credsData.refreshToken),callback()}function getAuthCredentialsError(error){logToConsole("getAuthCredentialsError: "+error)}if(!cordova)throw"Cordova/PhoneGap not found.";cordova.require("salesforce/plugin/oauth").getAuthCredentials(salesforceSessionRefreshed,getAuthCredentialsError),document.addEventListener("salesforceSessionRefresh",salesforceSessionRefreshed,!1)},this.loginWeb=function(callback){if(!SFConfig)throw"Must set app.SFConfig where app is your AngularJS app";if(SFConfig.client)return callback&&callback;var ftkClientUI=getForceTKClientUI();ftkClientUI.login(callback)},this.loginVF=function(){SFConfig.client=new forcetk.Client,SFConfig.client.setSessionToken(SFConfig.sessionId)},this.oauthCallback=function(callbackString){var ftkClientUI=getForceTKClientUI();ftkClientUI.oauthCallback(callbackString)},this.logout=function(callback){if(SFConfig.client){var ftkClientUI=getForceTKClientUI();ftkClientUI.client=SFConfig.client,ftkClientUI.instanceUrl=SFConfig.client.instanceUrl,ftkClientUI.proxyUrl=SFConfig.client.proxyUrl,ftkClientUI.logout(callback),SFConfig.client=null}}}),angular.module("AngularForceObjectFactory",[]).factory("AngularForceObjectFactory",function(SFConfig){function AngularForceObjectFactory(params){function AngularForceObject(props){angular.copy(props||{},this),this._orig=props||{}}params=params||{};var type=params.type,fields=params.fields,where=params.where,limit=params.limit,orderBy=params.orderBy;fields=fields&&fields.length>0?fields.join(","):"",where=where&&""!=where?" where "+where:"",limit=limit&&""!=limit?" LIMIT "+limit:"LIMIT 25",orderBy=orderBy&&""!=orderBy?" ORDER BY "+orderBy:"";var soql="SELECT "+fields+" FROM "+type+where+orderBy+limit,sosl="Find {__SEARCH_TERM_PLACEHOLDER__*} IN ALL FIELDS RETURNING "+type+" ("+fields+")";return AngularForceObject.prototype.update=function(successCB,failureCB){return AngularForceObject.update(this,successCB,failureCB)},AngularForceObject.prototype.destroy=function(successCB,failureCB){return AngularForceObject.remove(this,successCB,failureCB)},AngularForceObject.query=function(successCB,failureCB){return SFConfig.client.query(soql,successCB,failureCB)},AngularForceObject.search=function(searchTerm,successCB,failureCB){var fields=fields&&fields.length>0?"("+fields.join(", ")+")":"",s=sosl.replace("__SEARCH_TERM_PLACEHOLDER__",escape(searchTerm));return SFConfig.client.search(s,successCB,failureCB)},AngularForceObject.get=function(params,successCB,failureCB){return SFConfig.client.retrieve(type,params.id,fields,function(data){return successCB(data&&!angular.isArray(data)?new AngularForceObject(data):data)},failureCB)},AngularForceObject.save=function(obj,successCB,failureCB){var data=AngularForceObject.getNewObjectData(obj);return SFConfig.client.create(type,data,function(data){return data&&!angular.isArray(data)?(data.id&&(data.Id=data.id,delete data.id),successCB(new AngularForceObject(data))):successCB(data)},failureCB)},AngularForceObject.update=function(obj,successCB,failureCB){var data=AngularForceObject.getChangedData(obj);return SFConfig.client.update(type,obj.Id,data,function(data){return successCB(data&&!angular.isArray(data)?new AngularForceObject(data):data)},failureCB)},AngularForceObject.remove=function(obj,successCB,failureCB){return SFConfig.client.del(type,obj.Id,successCB,failureCB)},AngularForceObject.getChangedData=function(obj){var diff={},orig=obj._orig;return orig?(angular.forEach(params.fields,function(field){"Id"!=field&&obj[field]!==orig[field]&&(diff[field]=obj[field])}),diff):{}},AngularForceObject.getNewObjectData=function(obj){var newObj={};return angular.forEach(params.fields,function(field){"Id"!=field&&(newObj[field]=obj[field])}),newObj},AngularForceObject}return AngularForceObjectFactory});